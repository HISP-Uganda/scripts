!function(e){var t={};function n(a){if(t[a])return t[a].exports;var r=t[a]={i:a,l:!1,exports:{}};return e[a].call(r.exports,r,r.exports,n),r.l=!0,r.exports}n.m=e,n.c=t,n.d=function(e,t,a){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:a})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var a=Object.create(null);if(n.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(a,r,function(t){return e[t]}.bind(null,r));return a},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=0)}([function(e,t,n){const{generateUid:a}=n(1),r=n(2),l=n(3),o=n(4),i=n(5),s=n(6),u=n(7),c=(n(8)(),s(process.argv.slice(2))),d=n(9),m="http://admin:district@localhost:8080/dhis/api/trackedEntityInstances",g=e=>{const t=e.programTrackedEntityAttributes.filter(e=>e.trackedEntityAttribute.unique&&e.column);return t.length>0?t[0].column.value:null},f=e=>{const t=u.readFileSync(e),n=l.read(t,{type:"buffer",cellDates:!0,cellNF:!1,cellText:!1}),a=n.SheetNames;if(null!==n&&a.length>0)return l.utils.sheet_to_json(n.Sheets[a[0]],{range:0,dateNF:"YYYY-MM-DD"})},p=(e,t)=>{const n=g(e);if(null!==n&&t&&t.length>0){const e=t.map(e=>e[n]).filter(e=>null!==e&&void 0!==e);return i.chunk(e,50).map(e=>e.join(";"))}return[]},v=e=>{const t=e.programTrackedEntityAttributes.filter(e=>e.trackedEntityAttribute.unique);return t.length>0?t[0].trackedEntityAttribute.id:null},E=async(e,t)=>{let n=[];const a=v(e),r=t.map(e=>{return o({url:m,qs:{paging:!1,ouMode:"ALL",filter:a+":IN:"+e,fields:"trackedEntityInstance,orgUnit,attributes[attribute,value],enrollments[enrollment,program,trackedEntityInstance,trackedEntityType,enrollmentDate,incidentDate,orgUnit,events[program,trackedEntityInstance,event,eventDate,programStage,orgUnit,dataValues[dataElement,value]]]"},json:!0})});return await Promise.all(r.map(async e=>{const t=(await e).trackedEntityInstances;n=[...n,...t]})),n},y=(e,t)=>(t&&t.elements&&t.event?e=i.uniqBy(e,e=>{const n=t.elements.map(t=>{const n=i.filter(e.dataValues,{dataElement:t});if(n.length>0){return{exists:n[0].value}}return{exists:!1}});return i.some(n,{exists:!1})?e.event:JSON.stringify([e.eventDate,n])}):t&&t.elements?e=i.uniqBy(e,e=>{const n=t.elements.map(t=>{const n=i.filter(e.dataValues,{dataElement:t});if(n.length>0){return{exists:n[0].value}}return{exists:!1}});return i.some(n,{exists:!1})?e.event:JSON.stringify([n])}):t&&t.event&&(e=i.uniqBy(e,e=>e.eventDate)),e),h=(e,t,n)=>{if(n){const e=n.options.map(e=>({code:e.code,value:e.value})),a=i.find(e,e=>t===e.code||t===e.value);if(void 0!==a&&null!==a)return a.code}else if(((e,t)=>{switch(e){case"TEXT":case"LONG_TEXT":return t;case"NUMBER":return!isNaN(t);case"EMAIL":return/\S+@\S+\.\S+/.test(String(t).toLowerCase());case"BOOLEAN":return!1===t||!0===t;case"TRUE_ONLY":return!0===t;case"PERCENTAGE":return t>=0&&t<=100;case"INTEGER":return!isNaN(t)&&!isNaN(parseInt(t,10));case"DATE":return!0;case"DATETIME":return r(t,"YYYY-MM-DD HH:mm").isValid();case"TIME":return r(t,"HH:mm").isValid();case"UNIT_INTERVAL":return t>=0&&t<=1;case"INTEGER_NEGATIVE":return Number.isInteger(t)&&t>=0;case"NEGATIVE_INTEGER":return Number.isInteger(t)&&t<0;case"INTEGER_ZERO_OR_POSITIVE":case"AGE":return Number.isInteger(t)&&t>=0;default:return!0}})(e,t))return t;return null},Y=e=>"WITH_REGISTRATION"===e.programType,D=(e,t,n)=>{let l=[],o=[],s=[],u=[],c=[],m=[],f=[],p=[];const E=g(e),D=e.programStages,w=e.eventDateColumn,I=e.programTrackedEntityAttributes,M=e.enrollmentDateColumn,b=e.incidentDateColumn,x=((e,t)=>{const n=v(t),a=e.map(e=>{const t=i.find(e.attributes,{attribute:n}),a=t?t.value:null;return{...e,...i.fromPairs([[n,a]])}});return i.groupBy(a,n)})(n,e);if(E){let e=i.groupBy(t,E),n=[];i.forOwn(e,(e,t)=>{const a=x[t]||[];n=[...n,{client:t,data:e,previous:a}]}),t=n}else t&&t.length>0&&(t=t.map((e,t)=>({data:[e],client:t+1,previous:[]})));return t&&t.length>0&&t.forEach(t=>{let n=[],g=[],v=[],E=[],x={};t.data.forEach(a=>{D.forEach(r=>{let l=[],o=a[w.value];const s=r.programStageDataElements.filter(e=>e.column&&e.column.value);x[r.id]={elements:s.filter(e=>e.dataElement.identifiesEvent).map(e=>e.dataElement.id),event:r.eventDateIdentifiesEvent};let u={latitude:null,longitude:null};if(r.latitudeColumn&&r.longitudeColumn&&(u={latitude:a[r.latitudeColumn.value],longitude:a[r.longitudeColumn.value]}),o&&s.length){s.forEach(e=>{const n=a[e.column.value],r=e.dataElement.valueType,o=e.dataElement.optionSet,s=h(r,n,o);""!==n&&null!==s?l=[...l,{dataElement:e.dataElement.id,value:s}]:void 0!==n&&(f=[...f,{error:null===o?"Invalid value "+n+" for value type "+r:"Invalid value: "+n+", expected: "+i.map(o.options,e=>e.code).join(","),row:t.client,column:e.column.value}],d.log({level:"warn",message:"Invalid value "}))});let c={dataValues:l,eventDate:o,programStage:r.id,program:e.id,coordinate:u};r.completeEvents&&(c={...c,...{status:"COMPLETED",completedDate:o}}),n=[...n,c]}});let l=[];if(I.filter(e=>e.column&&e.column.value).forEach(e=>{const n=a[e.column.value],r=e.valueType,o=e.trackedEntityAttribute.optionSet,s=h(r,n,o);""!==n&&null!==s?l=[...l,{attribute:e.trackedEntityAttribute.id,value:s}]:""===n?d.log({level:"warn",message:"value was empty"}):(f=[...f,{error:o?"Invalid value "+n+" choose from options: "+i.map(o.options,e=>e.code).join(","):"Invalid value "+n+" for value type "+r,row:t.client,column:e.column.value}],d.log({level:"warn",message:"Invalid value "}))}),l.length>0&&(g=[...g,l]),Y(e)&&M&&b){const e=r(a[M.value],["YYYY-MM-DD","DD/MM/YYYY","MM/DD/YYYY"]),t=r(a[b.value],["YYYY-MM-DD","DD/MM/YYYY","MM/DD/YYYY"]);e.isValid()&&t.isValid()&&(v=[...v,{enrollmentDate:e.format("YYYY-MM-DD"),incidentDate:t.format("YYYY-MM-DD")}])}""!==e.orgUnitColumn&&(E=[...E,a[e.orgUnitColumn.value]])});let T=i.groupBy(n,"programStage");if(t.previous.length>1)m=[...m,t.previous];else if(1===t.previous.length)t.previous.forEach(t=>{const a=i.differenceBy(g[0],t.attributes,i.isEqual);let c=t.enrollments;if(a.length>0){const e=i.unionBy(g[0],t.attributes,"attribute");let n={...i.pick(t,["orgUnit","trackedEntityInstance","trackedEntityType"]),attributes:e};o=[...o,n]}n=n.map(e=>({...e,trackedEntityInstance:t.trackedEntityInstance,orgUnit:t.orgUnit})),T=i.groupBy(n,"programStage");const m=i.findIndex(c,{program:e.id});if(-1===m&&v.length>0){let n={program:e.id,orgUnit:t.orgUnit,trackedEntityInstance:t.trackedEntityInstance,...v[0]};u=[...u,n],e.createNewEvents?i.forOwn(T,(e,t)=>{const n=x[t],a=i.find(D,{id:t}),{repeatable:r}=a;if(e=y(e,n),r)s=[...s,...e];else{const t=i.maxBy(e,"eventDate");t.dataValues.length>0&&(s=[...s,t])}}):d.log({level:"warn",message:"Ignoring not creating new events"}),c=[...c,n],t={...t,enrollments:c}}else if(-1===m&&0===v.length)d.log({level:"warn",message:"Ignoring new enrollments"});else if(-1!==m){let e=c[m].events;i.forOwn(T,(t,n)=>{const a=i.find(D,{id:n}),{repeatable:o}=a,u=x[n];if(t=y(t,u),o)t.forEach(t=>{const a=((e,t,n,a)=>i.findIndex(e,e=>{if(!t)return!1;if(t.elements&&t.event){const l=t.elements.map(t=>{const n=i.filter(e.dataValues,{dataElement:t}),r=i.filter(a.dataValues,{dataElement:t});return r.length>0&&n.length>0?{exists:n[0].value===r[0].value}:{exists:!1}});return e.programStage===n&&r(e.eventDate,"YYYY-MM-DD").format("YYYY-MM-DD")===r(a.eventDate,"YYYY-MM-DD").format("YYYY-MM-DD")&&i.every(l,"exists")}if(t.elements){const r=t.elements.map(t=>{const n=i.filter(e.dataValues,{dataElement:t}),r=i.filter(a.dataValues,{dataElement:t});return r.length>0&&n>0?{exists:n[0].value===r[0].value}:{exists:!1}});return e.programStage===n&&i.every(r,"exists")}return t.event?e.programStage===n&&r(e.eventDate,"YYYY-MM-DD").format("YYYY-MM-DD")===r(a.eventDate,"YYYY-MM-DD").format("YYYY-MM-DD"):void 0}))(e,u,n,t);if(-1!==a){const n=e[a],r=i.unionBy(t.dataValues,n.dataValues,"dataElement"),o=i.differenceWith(t.dataValues,n.dataValues,i.isEqual);if(r.length>0&&o.length>0){const e={...n,dataValues:r};l=[...l,e]}}else s=[...s,t]});else{let a=i.find(e,{programStage:n}),r=i.maxBy(t,"eventDate");if(a){const e=i.unionBy(r.dataValues,a.dataValues,"dataElement"),t=i.differenceWith(r.dataValues,a.dataValues,i.isEqual);if(e.length>0&&t.length>0){const t={...a,dataValues:e};l=[...l,t]}}else s=[...s,r]}})}});else{let r;if((E=i.uniq(E)).length>1)p=[...p,{error:"Entity belongs to more than one organisation unit",row:t.client}],d.log({level:"warn",message:"Entity belongs to more than one organisation unit"});else if(1===E.length)if(r=((e,t)=>{const n=t.orgUnitStrategy,a=t.orgUnitStrategy;switch(n.value){case"uid":return i.find(a,{id:e});case"code":return i.find(a,{code:e});case"name":return i.find(a,{name:e});case"auto":const t=i.find(a,{id:e}),r=i.find(a,{code:e}),l=i.find(a,{name:e});return void 0!==t?t:void 0!==r?r:void 0!==l?l:void 0;default:return}})(E[0],e))if(v.length>0&&Y&&e.createNewEnrollments){const t=a();let n={orgUnit:r.id,attributes:g[0],trackedEntityInstance:t,trackedEntityType:e.trackedEntityType.id};c=[...c,n];let l={orgUnit:r.id,program:e.id,trackedEntityInstance:t,...v[0],enrollment:a()};e.createNewEvents&&i.forOwn(T,(e,n)=>{const l=x[n],o=i.find(D,{id:n}),{repeatable:u}=o;e=e.map(e=>({...e,orgUnit:r.id,event:a(),trackedEntityInstance:t})),e=y(e,l),s=u?[...s,...e]:[...s,i.maxBy(e,"eventDate")]}),u=[...u,l]}else!Y(e)&&e.createNewEvents&&(n=n.map(e=>({...e,orgUnit:r.id})),s=[...s,...n]);else p=[...p,{error:"Organisation unit "+E[0]+" not found using strategy "+e.orgUnitStrategy.value,row:t.client}],d.log({level:"warn",message:"Organisation unit "+E[0]+" not found using strategy "+e.orgUnitStrategy.value});else 0===E.length&&(p=[...p,{error:"Organisation unit missing",row:t.client}],d.log({level:"warn",message:"Organisation unit missing"}))}}),{newTrackedEntityInstances:c,newEnrollments:u,newEvents:s,trackedEntityInstancesUpdate:o,eventsUpdate:l,conflicts:f,duplicates:m,errors:p}},w=e=>{return o({method:"POST",uri:m,body:e,json:!0})},I=e=>{return o({method:"POST",uri:"http://admin:district@localhost:8080/dhis/api/enrollments",body:e,json:!0})},M=e=>{return o({method:"POST",uri:"http://admin:district@localhost:8080/dhis/api/events",body:e,json:!0})};setInterval(()=>{(async e=>{console.log(e);let t=await o({url:"http://admin:district@localhost:8080/dhis/api/dataStore/bridge/mappings",json:!0});for(const n of t){let t=null;e.x?t=f("/Users/carapai/projects/connector/"+e.x):e.a?(e.a,console.log("comming soon")):""!==n.url?t=await o({url:n.url,json:!0}):console.log("Nothing");const a=p(n,t),r=await E(n,a),l=D(n,t,r),{newTrackedEntityInstances:s,newEnrollments:u,newEvents:c,trackedEntityInstancesUpdate:d,eventsUpdate:m}=l;if(0!==s.length+u.length+d.length+c.length+m.length)if(Y(n)){const e=i.groupBy(c,"trackedEntityInstance"),t=i.groupBy(u,"trackedEntityInstance");if(s.length>0){const n=s.map(n=>{let a=t[n.trackedEntityInstance],r=e[n.trackedEntityInstance],l=null;return a&&a.length>0&&r&&r.length>0?(l={...a[0],events:r},n.enrollments=[l]):a&&a.length>0&&(l={...a[0]},n.enrollments=[l]),w(n)});await Promise.all(n.map(async e=>{let t=await e;console.log(t)}))}else if(u&&u.length>0){const e=i.groupBy(c,"trackedEntityInstance"),t=u.map(t=>{const n=e[t.trackedEntityInstance];return n&&n.length>0&&(t.events=n),I(t)});await Promise.all(t.map(async e=>{let t=await e;console.log(t)}))}else if(c&&c.length>0){const e=c.map(e=>M(e));await Promise.all(e.map(async e=>{let t=await e;console.log(t)}))}const n=d.map(e=>w(e));await Promise.all(n.map(async e=>{let t=await e;console.log(t)}));const a=m.map(e=>M(e));await Promise.all(a.map(async e=>{let t=await e;console.log(t)}))}else{const e=c.map(e=>M(e));await Promise.all(e.map(async e=>{let t=await e;console.log(t)}));const t=m.map(e=>M(e));await Promise.all(t.map(async e=>{let t=await e;console.log(t)}))}}})(c)},5e3)},function(e,t){const n="abcdefghijklmnopqrstuvwxyz",a=n.concat(n.toUpperCase()),r=`0123456789${a}`,l=r.length;function o(e){return Math.floor(Math.random()*e)}e.exports.generateUid=(()=>{let e=a.charAt(o(a.length));for(let t=1;t<11;t+=1)e+=r.charAt(o(l));return e})},function(e,t){e.exports=require("moment")},function(e,t){e.exports=require("xlsx")},function(e,t){e.exports=require("request-promise")},function(e,t){e.exports=require("lodash")},function(e,t){e.exports=require("minimist")},function(e,t){e.exports=require("fs")},function(e,t){e.exports=require("odbc")},function(e,t,n){const a=n(10),r=n(11),l={file:{level:"info",filename:`${a}/logs/connector.log`,handleExceptions:!0,json:!0,maxsize:5242880,maxFiles:5,colorize:!1},console:{level:"debug",handleExceptions:!0,json:!1,colorize:!0}},o=r.createLogger({level:"warn",format:r.format.json(),transports:[new r.transports.File(l.file),new r.transports.Console(l.console)],exitOnError:!1});o.stream={write:function(e,t){o.info(e)}},e.exports=o},function(e,t){e.exports=require("app-root-path")},function(e,t){e.exports=require("winston")}]);